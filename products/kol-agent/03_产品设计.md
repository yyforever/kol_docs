# 03 产品设计 — 自主 Agent 架构

> 状态：**草稿 v0.1**
> 更新：2026-02-25
> 依赖：`01_定位与假设.md`（v0.3，原则 P1-P7）、`02_用户场景.md`（v0.1）、`../kol-api/03_API能力设计.md`（7 Tool）、`../kol-api/05_PRD.md`（记忆架构）
> 本文回答：**Agent 怎么构建？Context、Tools、Memory、主动行为怎么设计？**

---

## 一、设计哲学

### 1.1 核心等式

```
kol-agent = OpenClaw 运行时 + 达人营销 Tools + 品牌专属 Context + 持久记忆
```

没有编排框架，没有状态机，没有 DAG。Agent 就是一个跑在 OpenClaw 上的自主 LLM，通过 Tools 操作世界，通过 Context 理解任务，通过 Memory 积累经验。

### 1.2 项目原则（P1-P7）

| # | 原则 | 对本文的约束 |
|---|------|------------|
| P1 | 自主 Agent，无编排 | 所有设计不得预设固定流程，Agent 自主决定每一步 |
| P2 | 基于外部 Agent 运行时 | 依赖 OpenClaw（或同类）提供 agentic loop、Context 管理、记忆系统、工具调用、会话管理、定时调度。不重建这些机制，在其上构建业务层 |
| P3 | 持久记忆，越用越好 | 记忆系统是核心飞轮，品牌级优先 |
| P4 | 每品牌持久会话 | 一个品牌 = 一个 OpenClaw session，记忆完全隔离 |
| P5 | Agent 主动工作 | 必须设计 heartbeat/cron 驱动的主动行为 |
| P6 | Tool 是原子操作 | Tool 不暗示流程，不返回 suggested_actions |
| P7 | HITL 是交互层的事 | Agent 架构不关心审批是按钮还是对话 |

### 1.3 与 kol-api 的关系

kol-api 设计了 7 个 Tool 给**外部** Agent 用（通过 MCP/CLI）。kol-agent 是**我们自己的** Agent，也用同一套 Tool：

```
外部 Agent（Claude Desktop / Cursor / 其他）     kol-agent（我们的 Agent）
         │                                            │
         ↓                                            ↓
    MCP Server / CLI                             CLI（直接 bash 调用）
         │                                            │
         └──────────────┬─────────────────────────────┘
                        ↓
                   Core 层（共享）
                   discover · analyze · outreach · negotiate · manage
                        │
                        ↓
                   聚星 Service 层
```

区别：
- 外部 Agent 怎么用 Tool 由第三方平台决定——我们控制不了
- kol-agent 怎么用 Tool 由我们设计——通过 Context Engineering 定义行为

### 1.4 类比：OpenClaw（知行）→ kol-agent

| 维度 | OpenClaw（知行） | kol-agent（品牌 AI 员工） |
|------|-------------|----------------------|
| 运行时 | OpenClaw Gateway | 同 |
| 用户 | 大哥（杨洋） | 品牌广告主 |
| 人格 | SOUL.md | Brand SOUL（品牌人格文件） |
| 工作指南 | AGENTS.md | Agent 工作指南（达人营销领域知识） |
| 工具 | read/write/exec/web_search/browser/message/cron… | nox CLI（7 Tool）+ 聚星邮件 + 通知 |
| 记忆 | MEMORY.md + memory/*.md | Brand Memory + Campaign 记忆 |
| 主动行为 | heartbeat 检查邮件/日历 | heartbeat 检查达人回复/截止日期 |
| 技能 | skills/*.md | 达人营销 Skills（搜索策略/谈判技巧/邮件模板） |

---

## 二、Context 设计（大脑）

### 2.1 机制与内容分离

OpenClaw（或同类 Agent 运行时）提供完整的 **Context 架构（机制层）**——System Prompt 注入、人格文件（SOUL.md）、工作指南（AGENTS.md）、Skill 系统、workspace 文件管理、记忆系统。这些机制不需要我们设计或重建。

**kol-agent 的工作是在机制之上提供业务内容。** 这些内容分四类：

| 类型 | 性质 | 来源 | 载体 | 例子 |
|------|------|------|------|------|
| **预置知识** | 静态，人工编写 | 运营/产品团队 | Skills、AGENTS.md | 邮件模板、谈判策略、行业基准、Tool 使用规范 |
| **品牌 Context** | 半静态，品牌填写 + Agent 维护 | 品牌 + Agent | Brand Profile | 品牌信息、达人偏好、预算、黑白名单 |
| **品牌内部流程** | 半静态，品牌定义 | 品牌 | Brand Process | 审批链、决策权限、合规要求、付款流程 |
| **执行经验** | 动态，Agent 工作中积累 | Agent 实际执行 | MEMORY.md | 达人回复规律、谈判弹性、内容效果对比、时机策略 |

前两类在 Agent 启动前就存在；第三类由品牌在 onboarding 或使用过程中定义；第四类**只能通过 Agent 实际工作积累**——这是"越用越好"的核心引擎。

### 2.2 Context 层次结构

```
┌─────────────────────────────────────────────────────────────────────┐
│  System Prompt（不可变，所有品牌共享）                     [机制：运行时原生] │
│  Agent 身份 + 项目原则 + 安全边界                                      │
├─────────────────────────────────────────────────────────────────────┤
│  SOUL.md — Agent 人格（所有品牌共享基础版）               [机制：运行时原生] │
│  内容：达人营销专家的沟通风格、判断标准、工作原则       [内容：预置知识]     │
├─────────────────────────────────────────────────────────────────────┤
│  AGENTS.md — 工作指南（所有品牌共享）                    [机制：运行时原生] │
│  内容：Tool 使用规范、记忆管理、行为准则              [内容：预置知识]     │
├─────────────────────────────────────────────────────────────────────┤
│  Skills — 领域技能（所有品牌共享，可热更新）              [机制：运行时原生] │
│  内容：搜索策略 / 邮件撰写 / 谈判技巧 / 效果分析       [内容：预置知识]     │
├─────────────────────────────────────────────────────────────────────┤
│  Brand Profile — 品牌画像（每品牌独有）                  [机制：workspace]  │
│  内容：品牌信息 / 偏好 / 预算 / 黑白名单             [内容：品牌 Context]  │
├─────────────────────────────────────────────────────────────────────┤
│  Brand Process — 品牌内部流程（每品牌独有）               [机制：workspace]  │
│  内容：审批链 / 决策权限 / 合规要求 / 付款流程         [内容：品牌流程]     │
├─────────────────────────────────────────────────────────────────────┤
│  Memory — 品牌记忆（每品牌独有，不断积累）                [机制：运行时原生] │
│  内容：合作经验 / 达人洞察 / 策略效果 / 时机规律       [内容：执行经验]     │
└─────────────────────────────────────────────────────────────────────┘
```

从上到下：共享 → 专属，静态 → 动态，人工 → Agent 生成。

### 2.2 System Prompt

System Prompt 定义 Agent 的身份和不可违背的规则，对标 OpenClaw 自身的 runtime 注入部分。

```
你是 NoxInfluencer Agent——品牌的达人营销 AI 员工。

你的工作是帮品牌完成从找达人→邀约→谈判→合作管理→效果追踪的完整流程。
你不是一个问答机器人，你是一个主动工作的员工——有事主动汇报，有进展主动推进，有风险主动预警。

核心原则：
- 你自主决定怎么完成任务，不需要等人告诉你下一步做什么
- 有需要品牌确认的事项（发邮件、开始谈判），主动请求确认
- 每次操作前，先查历史（调 manage_campaigns），不要重复问品牌已经告诉过你的事
- 你对这个品牌的了解会越来越深——善用记忆，让品牌感受到你在进步

安全边界：
- 不得在未经品牌确认的情况下发送邮件或开始谈判
- 不得跨品牌泄露任何数据
- 不确定的事情，问品牌
```

### 2.3 SOUL.md — Agent 人格

定义 Agent 的沟通风格和判断标准。所有品牌共享基础版，Enterprise 可自定义。

```markdown
# SOUL.md — NoxInfluencer Agent

## 核心特质
- **专业务实**：用数据说话，不吹嘘
- **主动但不烦人**：有实质进展才汇报，不为汇报而汇报
- **有判断力**：看到数据异常（假粉、互动率骤降）主动提醒
- **学习型**：记住品牌的偏好，下次不再问

## 沟通风格
- 简洁直接，先给结论再给数据
- 数字说话：互动率、粉丝量、报价、ROI 都要量化
- 中英文自适应（跟品牌语言一致）

## 判断标准
- 达人真实性 > 粉丝量
- 互动率 > 曝光量
- 品牌契合度 > 达人热度
- 长期关系 > 一次性合作
```

### 2.4 AGENTS.md — 工作指南

达人营销领域知识 + Tool 使用最佳实践 + 记忆管理规范。

```markdown
# AGENTS.md — 工作指南

## 每次会话启动
1. 读 Brand Profile（你服务的品牌是谁）
2. 读 Memory（最近发生了什么）
3. 检查待办（有没有等待回复的达人、即将到期的合作）

## Tool 使用原则
- **先查后做**：任何操作前先调 manage_campaigns 查历史
- **preview 先行**：outreach 和 negotiate 先 preview 再 confirm
- **批量优于逐个**：搜索一批 → 筛选 → 批量邀约，不要一个一个来
- **数据驱动**：推荐达人时附上数据（互动率、真实性评分、历史报价）

## 主动行为
- 每次 heartbeat 检查：
  - 达人邮件回复（通过聚星邮件 API）
  - Campaign 截止日期
  - 合作中的达人内容发布状态
- 发现新情况主动通知品牌

## 记忆管理
- 重要偏好写入 Memory（"品牌不喜欢争议性达人"）
- 合作结果记入 Memory（"@beautybyjess 两次合作 ROI 都很好"）
- 定期整理 Memory，淘汰过时信息
```

### 2.5 Skills — 领域技能

Skills 是可热更新的专项知识模块，对标 OpenClaw 的 Skill 系统。Agent 根据 description 自动匹配加载。

| Skill | 描述 | 关键内容 |
|-------|------|---------|
| `outreach-strategy` | 达人邀约策略 | 个性化邮件模板、A/B 测试策略、不同平台达人的偏好差异 |
| `negotiation-tactics` | 谈判技巧 | 定价基准参考、常见报价策略、不同量级达人的谈判差异 |
| `campaign-planning` | Campaign 规划 | 预算分配建议、达人组合策略、时间线规划 |
| `creator-evaluation` | 达人评估 | 假粉识别经验、互动率解读、受众质量判断 |
| `cross-cultural` | 跨文化沟通 | 中国出海品牌与海外达人沟通注意事项、文化差异 |
| `performance-analysis` | 效果分析 | ROI 计算、归因逻辑、效果对标基准 |

Skills 独立于 Agent 代码，可由运营团队持续补充和优化，Agent 自动受益。

### 2.6 Brand Profile — 品牌画像

每个品牌的专属配置文件。首次使用时由品牌填写 + Agent 引导补充，后续 Agent 自动维护。

```markdown
# Brand Profile — [品牌名]

## 基本信息
- 品牌名：Glow Beauty
- 行业：美妆 / 护肤
- 主要市场：US, UK
- 网站：glowbeauty.com

## 达人偏好
- 平台优先级：Instagram > TikTok > YouTube
- 粉丝量级：10K-500K（偏好微型+中型达人）
- 内容风格：干净美学、教程类、真实体验
- 黑名单：@fake_guru（假粉）、@drama_queen（争议）

## 预算与条款
- 单次 Campaign 预算：$5,000-15,000
- 单个达人上限：$2,000
- 偏好合作形式：产品置换 + 佣金 > 固定费用
- 合同要求：需签 NDA

## 历史偏好（Agent 自动维护）
- 最佳 ROI 达人类型：5-15 万粉美妆博主
- 历史合作均价：$600-800/帖
- 品牌喜欢达人先试用产品再出内容
```

### 2.7 Brand Process — 品牌内部流程

品牌内部流程定义了 Agent 在这个品牌里的行为边界——什么能自主做、什么需要谁审批、什么绝对不能做。这直接影响 Agent 的自主权范围（P1）和 HITL 边界（P7）。

```markdown
# Brand Process — [品牌名]

## 决策权限
- 搜索达人：Agent 自主（不需要审批）
- 发送邀约邮件：需 [营销经理] 确认
- 开始谈判：需 [营销经理] 确认
- 谈判报价 < $500：Agent 可自主接受
- 谈判报价 $500-2000：需 [营销经理] 确认
- 谈判报价 > $2000：需 [VP] 审批
- 签约/确认合作：需 [营销总监] 审批

## 审批链
- 日常操作 → 营销经理 Sarah
- 预算相关 → VP Marketing Mike
- 合同/法务 → Legal team（邮件 legal@brand.com）
- 紧急情况 → Sarah 优先，Mike 备选

## 合规要求
- 所有合作达人必须签 NDA
- 达人内容需加 #ad / #sponsored 标签（FTC 合规）
- 不得与竞品 [品牌X, 品牌Y] 有当前合约的达人合作
- 达人受众 < 18 岁占比不得超过 30%

## 付款流程
- 付款方式：产品寄送 + 佣金月结
- 佣金结算周期：内容发布后 30 天
- 发票要求：需要正式 invoice

## 内容审核
- 达人提交的内容需品牌审核后才能发布
- 审核周期：2 个工作日内
- 修改轮数上限：3 轮
```

Brand Process 的关键价值：
- **让 Agent 知道边界**：不同品牌的 Agent 自主权完全不同——小品牌创始人可能授权 Agent 全自主，大企业可能每步都要审批
- **HITL 具体化**：P7 说"HITL 是交互层的事"，Brand Process 就是定义具体在哪些节点需要 HITL
- **合规保障**：FTC/广告法等合规要求写在流程里，Agent 自动遵守
- **随时间演化**：品牌对 Agent 建立信任后，可以逐步放宽权限（从"每封邮件审批"到"同类邮件自动发"）

#### 对接品牌内部系统

中大型品牌通常有自己的内部系统（审批流、ERP、合同管理、财务系统等）。Brand Process 不仅可以是静态配置文件，还可以对接品牌内部系统：

| 场景 | 静态配置（SMB） | 系统对接（Enterprise） |
|------|---------------|---------------------|
| 审批 | Agent 在 Chat 中请求确认 | Agent 调用品牌审批系统 API，自动创建审批单 |
| 合同 | Agent 生成合同草案，品牌手动签署 | Agent 对接品牌合同管理系统（DocuSign 等） |
| 付款 | Agent 提醒品牌手动付款 | Agent 对接品牌 ERP/财务系统触发付款流程 |
| 合规 | Agent 按配置文件中的规则检查 | Agent 查询品牌合规系统获取实时规则 |
| 达人黑名单 | Brand Profile 中维护 | 对接品牌 CRM 系统的达人黑名单 |

实现方式：
- **SMB / Free-Growth**：Brand Process 是配置文件，Agent 按规则执行，审批通过 Chat 交互完成
- **Enterprise**：Brand Process 可包含 API endpoint 配置，Agent 通过内部 Tool 调用品牌系统
  ```markdown
  ## 系统集成（Enterprise）
  - 审批系统：POST https://brand.internal/api/approvals
  - 合同系统：DocuSign API（token 由品牌提供）
  - 财务系统：SAP API（仅查询付款状态）
  - CRM：HubSpot API（同步达人关系数据）
  ```
- **渐进式**：品牌可以从纯配置文件起步，随信任建立逐步开放系统对接

> ⚠️ **待验证**：品牌内部流程对接是初步设想，具体的流程节点、系统集成方式、审批粒度需要跟真实品牌用户迭代后确认。不同规模和行业的品牌差异可能很大，上述示例仅作为设计框架参考。

### 2.8 经验回流机制

执行经验是 Agent 通过实际工作积累的知识，不是人预先写入的。这些经验有两个层级：

| 层级 | 来源 | 存储 | 例子 |
|------|------|------|------|
| **品牌级** | 单个品牌的 Agent 执行 | 该品牌的 MEMORY.md | "@jess 每次都准时交付"、"这个品牌教程类内容 ROI 最高" |
| **平台级** | 跨品牌的聚合分析 | 需专门研发（P3 约束） | "美妆品类达人周末回复率高 30%"、"5-15K 粉达人谈判弹性最大" |

品牌级经验由 Agent 自然积累——每次合作结束后 Agent 自主总结写入 Memory。这不需要额外研发。

平台级经验（跨品牌聚合洞察）**不是 Agent 自动产生的**——需要专门的数据分析和研发投入，将聚合规律反哺到 Skills 中。这属于 P3 约束的"平台级数据提升需专门研发投入"。

---

## 三、Tools 设计（双手）

### 3.1 Tool 全景

Agent 的 Tool 分两类：**外部 Tool**（kol-api Core 层，也供外部 Agent 使用）和**内部 Tool**（仅 kol-agent 使用）。

```
┌─ 外部 Tool（kol-api Core，共享）──────────────────────┐
│  discover_creators    搜索达人                         │
│  analyze_creator      深度分析                         │
│  outreach_creators    邮约达人                         │
│  negotiate            AI 谈判                         │
│  manage_campaigns     Campaign 管理（记忆经验库）       │
│  competitive_intel    竞品分析                    [P1] │
│  track_performance    效果追踪                    [P2] │
└────────────────────────────────────────────────────────┘

┌─ 内部 Tool（kol-agent 专属）──────────────────────────┐
│  nox_email_check      检查达人邮件回复                  │
│  nox_email_read       读取邮件内容                      │
│  nox_notify           通知品牌（Chat/Dashboard 推送）   │
│  nox_schedule         设置定时任务（follow-up/提醒）     │
│  nox_brand_profile    读写品牌画像                      │
│  nox_memory           读写品牌长期记忆                   │
└────────────────────────────────────────────────────────┘
```

### 3.2 外部 Tool 调用方式

kol-agent 跑在 OpenClaw 上，通过 bash 调用 `nox` CLI（与外部 Agent 共享同一 Core 层）：

```bash
# 搜索达人
nox search "US beauty TikTokers 10K-500K followers"

# 深度分析
nox analyze @beautybyjess --deep

# 批量邀约（先预览）
nox outreach @beautybyjess @glowwithme --brief "protein powder launch" --preview

# 确认发送
nox outreach @beautybyjess @glowwithme --brief "protein powder launch" --send

# 查历史
nox campaigns --creator @beautybyjess

# 谈判
nox negotiate @beautybyjess --max 900 --target 800 --preview
```

Agent 自主决定调什么、什么顺序、什么参数。CLI 的管道组合能力让 Agent 可以自由编排：

```bash
# 搜索 → 过滤高互动率 → 批量邀约预览
nox search "US beauty TikTokers" --json | \
  jq '[.[] | select(.engagement_rate > 0.05)]' | \
  nox outreach --stdin --brief "..." --preview
```

### 3.3 内部 Tool 设计

#### `nox_email_check` — 检查达人邮件回复

对接聚星现有邮件系统 API。参考 GOG（Peter Steinberger）的 Gmail CLI 模式：Agent 通过 CLI 查询邮件，不需要 webhook。

```bash
# 检查最近 1 小时的达人回复
nox email check --since 1h --campaign cmp_001

# 返回：新回复列表 + 发件人 + 主题 + 摘要
```

| 参数 | 必填 | 说明 |
|------|:----:|------|
| `--since` | | 时间范围（1h/6h/1d），默认上次检查以来 |
| `--campaign` | | 限定 Campaign |
| `--creator` | | 限定达人 |

#### `nox_email_read` — 读取邮件内容

```bash
# 读取特定邮件
nox email read msg_abc123
```

#### `nox_notify` — 通知品牌

通过聚星平台的消息通道推送通知到品牌。

```bash
# Chat 消息
nox notify --type chat --message "达人 @beautybyjess 回复了邀约，感兴趣！要我开始谈价吗？"

# Dashboard 推送
nox notify --type dashboard --campaign cmp_001 --event "creator_replied" --data '{"creator": "@beautybyjess"}'
```

#### `nox_schedule` — 定时任务

复用 OpenClaw 的 cron 能力。

```bash
# 3 天后自动 follow-up
nox schedule --in 3d --action "follow_up" --creator @beautybyjess --campaign cmp_001

# 每天早 9 点检查邮件
nox schedule --cron "0 9 * * *" --action "email_check" --campaign cmp_001
```

#### `nox_brand_profile` — 品牌画像读写

```bash
# 读取品牌画像
nox brand get

# 更新偏好
nox brand update --key "preferred_creator_size" --value "10K-500K"

# 加入黑名单
nox brand blacklist add @fake_guru --reason "假粉 38%"
```

#### `nox_memory` — 品牌长期记忆

映射到 OpenClaw 原生的 memory 系统（MEMORY.md + memory/*.md）。

```bash
# 写入记忆
nox memory write "与 @beautybyjess 第二次合作，ROI $5.2/$1，是品牌最佳合作达人之一"

# 搜索记忆
nox memory search "beautybyjess 合作历史"

# 读取最近记忆
nox memory recent --days 7
```

### 3.4 Tool 总数控制

| 类别 | 数量 | 说明 |
|------|:----:|------|
| 外部 Tool（kol-api） | 5+2 | Day 1 上 5 个，v1.1 加 2 个 |
| 内部 Tool | 6 | kol-agent 专属 |
| **合计** | **13** | 低于 Microsoft Research 的 20 个上限 |

---

## 四、记忆管理（经验）

### 4.1 记忆是核心飞轮（P3）

记忆不是附加功能，是产品的核心价值。品牌留存的根本原因不是功能——功能竞品都能抄——而是 Agent 对这个品牌越来越懂。换一个产品意味着从零开始，这就是锁定。

### 4.2 三层记忆架构

| 层 | 载体 | 内容 | 生命周期 | 谁管理 |
|---|------|------|---------|-------|
| **会话记忆** | OpenClaw session context | 当前对话上下文 | 单次会话 | 自动 |
| **品牌记忆** | MEMORY.md + memory/*.md | 品牌偏好、经验教训、达人关系洞察 | 永久（Agent 维护） | Agent 自主写入 + 定期整理 |
| **结构化记忆** | manage_campaigns（Core 层） | Campaign 状态、合作历史、达人数据 | 永久（数据库） | Tool 自动记录 |

三层互补：
- **会话记忆**：这轮对话的连贯性（"刚才搜了美妆达人，现在要邀约"）
- **品牌记忆**：跨会话的隐性知识（"这个品牌不喜欢争议达人"、"@beautybyjess 很靠谱"）
- **结构化记忆**：跨会话的显性数据（Campaign 状态、合作历史、效果数据）

### 4.3 品牌记忆的内容

Agent 在工作过程中自主写入品牌记忆（MEMORY.md），内容包括：

| 类别 | 示例 |
|------|------|
| **偏好发现** | "品牌偏好微型达人（5-15K 粉），认为大号 ROI 不如小号" |
| **合作经验** | "@beautybyjess 两次合作都超出预期，ROI $5.2/$1，是品牌最佳合作达人" |
| **教训** | "@fake_guru 粉丝 38% 是假的，合作效果极差，已加入黑名单" |
| **策略调整** | "品牌从固定费用转向产品置换+佣金模式，因为 ROI 更好" |
| **沟通偏好** | "品牌 CEO 亲自管营销，回复通常在北京时间晚 10 点后" |
| **行业洞察** | "美妆品类在 Q4 达人报价普遍上涨 20-30%，需要提前锁定" |

### 4.4 记忆维护

Agent 通过 heartbeat 定期整理记忆（对标 OpenClaw 的 AGENTS.md 中 Memory Maintenance 规范）：

1. **写入**：每次有意义的交互后，Agent 自主判断是否写入记忆
2. **整理**：定期回顾 daily memory，将值得长期保留的提炼到 MEMORY.md
3. **淘汰**：过时信息（"Q3 Campaign 已完成"）归档或删除
4. **重建**：即使 Agent 记忆意外丢失，调一次 `manage_campaigns` 可从结构化数据重建关键上下文

### 4.5 记忆效果演进

| 使用阶段 | Agent 表现 | 记忆状态 |
|---------|-----------|---------|
| **第 1 次** | 追问基本信息：平台、品类、预算、风格 | 空白，Brand Profile 初始化中 |
| **第 3 次** | 按已知偏好搜索，只确认新变量 | Brand Profile 基本完整 |
| **第 5 次** | 主动参考历史合作效果推荐达人 | 品牌记忆开始积累 |
| **第 10 次** | "上次 @beautybyjess 效果很好，这次她有新的合作档期，要邀约吗？" | 记忆丰富，主动推荐 |
| **第 20 次** | "根据过去 6 次 Campaign 数据，微型美妆博主 ROI 最高，建议本次预算 60% 分配给 5-15K 粉达人" | 品牌记忆 → 策略建议 |

---

## 五、主动行为设计（P5 Agent 主动工作）

### 5.1 主动行为的触发机制

OpenClaw 提供两种原生触发机制：

| 机制 | 适用场景 | 频率 |
|------|---------|------|
| **Heartbeat** | 批量检查：邮件回复、截止日期、合作状态 | 每 30-60 分钟 |
| **Cron** | 精确定时任务：follow-up、每日报告、定时提醒 | 自定义 |

### 5.2 Heartbeat 检查清单

Agent 在每次 heartbeat 时轮询以下事项（参考 GOG Skill 的邮件检查模式）：

```markdown
# HEARTBEAT.md — kol-agent

## 每次 heartbeat 检查
1. 新邮件回复：nox email check --since last_heartbeat
2. 即将到期的 Campaign 截止日期（< 48h）
3. 待 follow-up 的达人（发出邀约 > 3 天无回复）
4. 合作中达人的内容发布状态
5. 品牌未处理的审批请求（> 24h）

## 发现情况后的行动
- 新回复 → 读取内容 → 判断意向 → 通知品牌并建议下一步
- 即将到期 → 通知品牌
- 需要 follow-up → 自动发送（如已授权）或请求品牌确认
- 品牌未审批 → 温和提醒
```

### 5.3 典型主动行为模式

#### 模式 A：达人回复处理

```
[Heartbeat 触发]
Agent: 检查邮件...发现 @beautybyjess 回复了邀约邮件
Agent: 读取邮件内容 → 达人表示感兴趣，但希望了解更多产品信息
Agent: → 通知品牌：

  "📬 @beautybyjess 回复了邀约！
   她对合作感兴趣，想了解更多产品细节。
   
   建议：我回复她产品信息和合作条款，要我起草回复吗？"
```

#### 模式 B：智能 Follow-up

```
[Cron 触发：邀约发出 3 天]
Agent: 检查 Campaign #cmp_001，5 位达人未回复
Agent: 对比历史数据 → 这个品类达人平均 2 天回复
Agent: → 自动发送个性化 follow-up（如品牌已授权）
Agent: → 通知品牌：

  "📧 5 位达人 3 天未回复，已发送 follow-up。
   其中 @glowwithme 通常在周末回复，我会持续跟踪。"
```

#### 模式 C：主动策略建议

```
[Heartbeat 触发 + Campaign 进行中]
Agent: Campaign #cmp_001 已运行 2 周
Agent: 调 track_performance → 当前 ROI $3.8/$1
Agent: 对比品牌历史记忆 → 上次同类 Campaign ROI $5.2/$1
Agent: → 通知品牌：

  "📊 Campaign #cmp_001 半程报告：
   当前 ROI $3.8/$1，低于上次同类 Campaign 的 $5.2/$1。
   
   主要差异：本次大量级达人占比高（40% vs 上次 15%），
   而微型达人 ROI 一直更高。
   
   建议：剩余预算调整为微型达人优先，要我重新搜索吗？"
```

### 5.4 主动行为的边界

| 可以自动做 | 必须问品牌 |
|-----------|-----------|
| 检查邮件、读取回复 | 发送首次邀约邮件 |
| 发送 follow-up（如已授权） | 开始谈判 |
| 发送提醒和状态报告 | 确认合作/签约 |
| 更新 CRM 数据 | 超出预算的操作 |
| 整理和更新记忆 | 接触黑名单达人 |

---

## 六、多租户架构

### 6.1 两种部署模式

| 层级 | 模式 | Agent 实例 | 记忆隔离 | 适用 |
|------|------|-----------|---------|------|
| **Free-Growth** | 共享 OpenClaw | 同一实例，按 brand_id 切换 context | 应用层（文件系统目录隔离） | SMB / 个人品牌 |
| **Enterprise** | AgentPod 独立容器 | 每品牌独立 OpenClaw 实例 | 容器级物理隔离 | MCN / Agency / 大品牌 |

### 6.2 Free-Growth：共享实例

```
OpenClaw 实例
├── brands/
│   ├── brand_001/
│   │   ├── SOUL.md          (可使用默认)
│   │   ├── brand_profile.md
│   │   ├── MEMORY.md
│   │   └── memory/
│   │       ├── 2026-02-25.md
│   │       └── ...
│   ├── brand_002/
│   │   ├── ...
│   └── ...
├── shared/
│   ├── AGENTS.md            (所有品牌共享)
│   └── skills/              (所有品牌共享)
```

品牌切换时，Agent 加载对应品牌的 context 目录。应用层确保品牌间不可访问彼此数据。

### 6.3 Enterprise：AgentPod 独立容器

```
AgentPod
├── Pod-brand_A/  (独立 OpenClaw 实例)
│   ├── SOUL.md           (可自定义)
│   ├── AGENTS.md         (基础版 + 自定义)
│   ├── brand_profile.md
│   ├── MEMORY.md
│   ├── memory/
│   └── skills/           (基础版 + 自定义)
├── Pod-brand_B/  (独立 OpenClaw 实例)
│   └── ...
```

每个 Pod 是完整的 OpenClaw 实例：
- 独立记忆（物理隔离）
- 可自定义 SOUL.md（品牌人格）
- 可添加自定义 Skills
- 可导出迁移（容器直接打包）
- 崩溃互不影响

### 6.4 资源估算

| 项 | Free-Growth | Enterprise |
|-----|-----------|-----------|
| Agent 实例 | 1 个共享 | 每品牌 1 个 |
| RAM/品牌 | ~50MB（context 切换） | ~256MB（独立容器） |
| 服务器承载 | 1 台 → 数百品牌 | 1 台（8GB/4核）→ 20-30 品牌 |
| 月成本/品牌 | < $1 | ~$5-15 |

---

## 七、聚星后端集成

### 7.1 集成架构

kol-agent 作为独立微服务，与聚星 Java 后端通过 API 互调：

```
┌──────────────────────────────┐     ┌──────────────────────────────┐
│  kol-agent 微服务             │     │  聚星 Java 后端               │
│                              │     │                              │
│  OpenClaw + nox CLI          │────→│  用户认证 API                 │
│                              │←────│  达人数据 API                 │
│  Brand Context               │────→│  邮件发送 API                 │
│  Memory Files                │←────│  邮件接收/查询 API            │
│  Skills                      │────→│  合作数据 API                 │
│                              │←────│  支付/订阅状态 API            │
└──────────────────────────────┘     └──────────────────────────────┘
```

### 7.2 kol-agent 调聚星的 API

| API | 用途 | 调用方 |
|-----|------|-------|
| 用户认证 | 验证品牌身份、获取权限 | Agent 启动时 |
| 达人数据 | 搜索、画像、评估（Core 层封装） | nox CLI → Core |
| 邮件发送 | 发出邀约/谈判/follow-up 邮件 | nox CLI → Core → 聚星邮件 |
| 邮件查询 | 检查达人回复 | nox email check |
| 合作数据 | Campaign 状态、合作历史 | nox campaigns |
| 订阅状态 | 配额检查、功能权限 | Core 层内部 |

### 7.3 聚星调 kol-agent 的 API

| API | 用途 | 触发方 |
|-----|------|-------|
| 品牌消息 | 品牌在 Chat 中发消息 | 聚星前端 → Agent |
| Dashboard 操作 | 品牌在 Dashboard 点击审批 | 聚星前端 → Agent |
| Webhook 回调 | 邮件系统事件通知（可选，备用方案） | 聚星邮件系统 |

### 7.4 邮件系统集成细节

参考 GOG Skill 的模式——Agent 主动轮询而非被动等 webhook：

```
Agent（heartbeat/cron 驱动）
    │
    ├── nox email check → 聚星邮件查询 API → 新回复列表
    │
    ├── nox email read msg_xxx → 聚星邮件内容 API → 邮件全文
    │
    └── nox outreach ... --send → Core → 聚星邮件发送 API → 发出
```

轮询优势：
- 简单（不需要 webhook 基础设施）
- 可靠（不依赖事件推送的可靠性）
- 批量（一次检查所有 Campaign 的回复）
- 符合 P2（复用 OpenClaw 原生 heartbeat/cron）

---

## 八、结构化数据：Core 层负责

### 8.1 设计决策：kol-agent 不自建数据库

所有结构化数据（Campaign 状态、达人关系、邀约记录、谈判记录）由 **Core 层**（kol-api）负责存储和管理。kol-agent 通过 `manage_campaigns` 等 Tool 读写，不直接操作数据库。

```
kol-agent                          Core 层（kol-api）
                                   
非结构化记忆                        结构化数据
├── MEMORY.md（品牌洞察）     ←→    ├── campaigns
├── memory/*.md（日志）             ├── creator_relationships  
└── brand_profile.md（画像）        ├── outreach_attempts
                                   └── negotiations
        │                                   │
        └── Agent 自主管理                   └── Tool 自动记录
```

### 8.2 为什么不自建

- **符合 P6**：Agent 通过 Tool 操作数据，不直接碰数据库
- **一致性**：外部 Agent（Claude Desktop 等）和 kol-agent 用同一套数据
- **职责清晰**：Core 层管结构化数据，Agent 管非结构化记忆
- **简单**：少一套数据库 = 少一层维护

### 8.3 两类数据的分工

| 维度 | Core 层（manage_campaigns） | Agent 记忆（MEMORY.md） |
|------|--------------------------|----------------------|
| 数据类型 | 结构化（谁、什么时候、多少钱） | 非结构化（为什么、怎么改进、什么有效） |
| 写入方式 | Tool 自动记录 | Agent 自主判断写入 |
| 查询方式 | manage_campaigns（精确查询） | memory_search（语义搜索） |
| 丢失影响 | 灾难性（核心业务数据） | 可重建（调 manage_campaigns 恢复关键上下文） |
| 归属 | kol-api 团队维护 | kol-agent 自行管理 |

---

## 九、决策清单

| # | 问题 | 决策 | 状态 |
|---|------|------|:----:|
| D13 | Agent 运行时 | OpenClaw（P2） | ✅ |
| D14 | Context 层次 | 7 层：System Prompt → SOUL → AGENTS → Skills → Brand Profile → Brand Process → Memory | ✅ |
| D15 | Tool 数量 | 外部 7 + 内部 6 = 13（< 20 上限） | ✅ |
| D16 | 记忆架构 | 三层：会话 + 品牌记忆 + 结构化记忆 | ✅ |
| D17 | 邮件集成 | 轮询模式（heartbeat/cron），不依赖 webhook | ✅ |
| D18 | 多租户 | Free-Growth 共享实例 / Enterprise AgentPod 独立 | ✅ |
| D19 | 结构化数据 | Core 层负责，kol-agent 不自建数据库 | ✅ |
| D20 | 前端框架 | 🔴 待定（不影响 Agent 架构） | 🔴 |
| D21 | LLM 选型 | 🔴 待定（不影响 Agent 架构） | 🔴 |

---

## 十、与已有文档的一致性

| 校验项 | 01 定义 | 02 定义 | kol-api 03/05 | 本文 | 一致 | 备注 |
|--------|--------|--------|-------------|------|:----:|------|
| 原则 P1-P7 | ✅ 定义 | — | — | ✅ 遵循 | ✅ | P2 已更新为"基于外部 Agent 运行时" |
| P2 运行时依赖 | "不重建机制，构建业务层" | — | — | Context 机制/内容分离 | ✅ | 01 和 03 一致 |
| Tool 设计 | 概述 | 场景交互 | ✅ 7 Tool 详设 | 复用 + 6 内部 Tool | ✅ | |
| 记忆架构 | 概述 | CRM 是记忆基础 | ✅ 两层 + 演进 | 三层详设 | ✅ | 03 将 kol-api 的两层拆为三层（会话/品牌/结构化） |
| HITL | 权限表 | 10 节点详设 | 两阶段 confirm | P7 交互层 + Brand Process | ✅ | 02 的 10 节点审批 = 03 Brand Process 的具体化 |
| 品牌流程 | — | 审批节点表(§4.1) | — | Brand Process(§2.7) | ✅ | 02 定义了审批节点，03 定义了 Agent 如何感知和执行 |
| 多租户 | 部署模式 | Enterprise 场景(§场景5) | — | 详细设计(§6) | ✅ | |
| 结构化数据 | — | — | manage_campaigns | Core 层负责，Agent 不自建 | ✅ | |
| 客户策略 | 双线并列 | 5 场景 | — | — | ✅ | |
| Context 内容分类 | — | — | 05_PRD 两层记忆 | 四类内容 | ✅ | 03 在 kol-api 05 基础上增加品牌流程和执行经验 |

---

*下一步：04_定价与商业模式 → 订阅制详设 + 配额校准 + Enterprise 定价*
